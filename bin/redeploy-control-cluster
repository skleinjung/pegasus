#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

sh "${DIR}/deploy"

# configuration
CONFIG_PATH=/large-pool/config/snippets
TEMPLATE_ID=103
VMID=502

# update user-data
# curl -sL https://raw.githubusercontent.com/skleinjung/pegasus/master/configurations/k3s-server/user-data.yaml -o "${CONFIG_PATH}/k3s-server-user-data.yaml"

read -r -d '' PROXMOX_COMMANDS <<EOF
  qm stop "${VMID}"
  qm destroy "${VMID}" --purge
  qm clone "${TEMPLATE_ID}" "${VMID}" --name k3s-control-server
  qm resize "${VMID}" scsi0 +12G
  qm set "${VMID}" -memory 4096
  qm set "${VMID}" -balloon 2048
  qm set "${VMID}" --cicustom "user=config:snippets/k3s-control-server-user-data.yaml"
  qm start "${VMID}"
EOF

# recreate VM with new settings
echo "(Re)creating VM..."
echo "sudo -- sh -c \"${PROXMOX_COMMANDS}\"" | ssh -T typhon.pegasus